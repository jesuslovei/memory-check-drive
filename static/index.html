<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>암송 자동 확인</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:600px; margin:auto; padding:20px; }
    .verse-box { background:#f5f5f5; padding:10px; margin-top:10px; border-radius:6px; }
    button { margin-top:10px; padding:8px 16px; cursor:pointer; }
  </style>
</head>
<body>
  <h2>📖 수요제자반 암송 자동 확인</h2>
  <label>이름: <input id="name" placeholder="이름 입력" /></label><br/><br/>

  <label>언어 선택:</label><br/>
  <label><input type="radio" name="lang" value="kr" checked> 한국어</label>
  <label><input type="radio" name="lang" value="en"> English (ESV)</label>

  <h3>이번 주 암송 구절</h3>
  <div id="verses" class="verse-box">불러오는 중...</div>

  <button id="recordBtn">🎙️ 녹음 시작</button>
  <button id="stopBtn" disabled>⏹️ 녹음 종료</button>
  <button id="submitBtn" disabled>✅ 제출하기</button>

  <p id="status"></p>
  <pre id="result"></pre>
  <audio id="audioPlayer" controls style="display:none;"></audio>

<script>
let mediaRecorder, audioChunks = [];

fetch("/verses").then(r => r.json()).then(data => {
  const box = document.getElementById("verses");
  box.innerHTML = data.verses.map(v => `<b>${v.verse_id}</b>`).join("<br/>");
});

document.getElementById("recordBtn").onclick = async () => {
  audioChunks = [];
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();
  document.getElementById("recordBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
};

document.getElementById("stopBtn").onclick = () => {
  mediaRecorder.stop();
  mediaRecorder.onstop = () => {
    const blob = new Blob(audioChunks, { type:"audio/webm" });
    document.getElementById("audioPlayer").src = URL.createObjectURL(blob);
    document.getElementById("audioPlayer").style.display = "block";
    document.getElementById("submitBtn").disabled = false;
  };
  document.getElementById("stopBtn").disabled = true;
};

document.getElementById("submitBtn").onclick = async () => {
  const blob = new Blob(audioChunks, { type:"audio/webm" });
  const form = new FormData();
  form.append("audio", blob);
  form.append("name", document.getElementById("name").value);
  form.append("lang", document.querySelector("input[name='lang']:checked").value);
  document.getElementById("status").innerText = "제출 중...";

  const res = await fetch("/submit", { method:"POST", body:form });
  const data = await res.json();
  document.getElementById("result").innerText =
    `합격 여부: ${data.passed ? "✅ 합격" : "❌ 재도전"}\n\n점수:\n` +
    data.scores.map(s => `${s.verse}: ${s.score}`).join("\n") +
    `\n\n인식된 문장:\n${data.transcript}\n\n저장 링크:\n${data.file}`;
};
</script>
</body>
</html>
