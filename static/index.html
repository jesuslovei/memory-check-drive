<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì•”ì†¡ ìë™ í™•ì¸</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:600px; margin:auto; padding:20px; }
    .verse-box { background:#f5f5f5; padding:10px; margin-top:10px; border-radius:6px; }
    button { margin-top:10px; padding:8px 16px; cursor:pointer; }
  </style>
</head>
<body>
  <h2>ğŸ“– ìˆ˜ìš”ì œìë°˜ ì•”ì†¡ ìë™ í™•ì¸</h2>
  <label>ì´ë¦„: <input id="name" placeholder="ì´ë¦„ ì…ë ¥" /></label><br/><br/>

  <label>ì–¸ì–´ ì„ íƒ:</label><br/>
  <label><input type="radio" name="lang" value="kr" checked> í•œêµ­ì–´</label>
  <label><input type="radio" name="lang" value="en"> English (ESV)</label>

  <h3>ì´ë²ˆ ì£¼ ì•”ì†¡ êµ¬ì ˆ</h3>
  <div id="verses" class="verse-box">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <button id="recordBtn">ğŸ™ï¸ ë…¹ìŒ ì‹œì‘</button>
  <button id="stopBtn" disabled>â¹ï¸ ë…¹ìŒ ì¢…ë£Œ</button>
  <button id="submitBtn" disabled>âœ… ì œì¶œí•˜ê¸°</button>

  <p id="status"></p>
  <pre id="result"></pre>
  <audio id="audioPlayer" controls style="display:none;"></audio>

<script>
let mediaRecorder, audioChunks = [];

fetch("/verses").then(r => r.json()).then(data => {
  const box = document.getElementById("verses");
  box.innerHTML = data.verses.map(v => `<b>${v.verse_id}</b>`).join("<br/>");
});

document.getElementById("recordBtn").onclick = async () => {
  audioChunks = [];
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();
  document.getElementById("recordBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
};

document.getElementById("stopBtn").onclick = () => {
  mediaRecorder.stop();
  mediaRecorder.onstop = () => {
    const blob = new Blob(audioChunks, { type:"audio/webm" });
    document.getElementById("audioPlayer").src = URL.createObjectURL(blob);
    document.getElementById("audioPlayer").style.display = "block";
    document.getElementById("submitBtn").disabled = false;
  };
  document.getElementById("stopBtn").disabled = true;
};

document.getElementById("submitBtn").onclick = async () => {
  const blob = new Blob(audioChunks, { type:"audio/webm" });
  const form = new FormData();
  form.append("audio", blob);
  form.append("name", document.getElementById("name").value);
  form.append("lang", document.querySelector("input[name='lang']:checked").value);
  document.getElementById("status").innerText = "ì œì¶œ ì¤‘...";

  const res = await fetch("/submit", { method:"POST", body:form });
  const data = await res.json();
  document.getElementById("result").innerText =
    `í•©ê²© ì—¬ë¶€: ${data.passed ? "âœ… í•©ê²©" : "âŒ ì¬ë„ì „"}\n\nì ìˆ˜:\n` +
    data.scores.map(s => `${s.verse}: ${s.score}`).join("\n") +
    `\n\nì¸ì‹ëœ ë¬¸ì¥:\n${data.transcript}\n\nì €ì¥ ë§í¬:\n${data.file}`;
};
</script>
</body>
</html>
