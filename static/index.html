<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë§ì”€ ì•”ì†¡ ì œì¶œ</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1e293b;
      --muted: #64748b;
      --card: #f8fafc;
      --border: #e2e8f0;
      --brand: #2563eb;
      --brand-light: #dbeafe;
      --success: #16a34a;
      --warn: #eab308;
      --danger: #dc2626;
    }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      line-height: 1.5;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 22px;
    }
    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 15px;
    }
    label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
      font-size: 15px;
    }
    .verse-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
    }
    .verse-item.active {
      background: var(--brand-light);
      border-color: var(--brand);
    }
    button {
      width: 100%;
      padding: 12px;
      border: none;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 600;
    }
    .record-btn { background: var(--brand); color: white; }
    .stop-btn { background: var(--warn); color: black; }
    .submit-btn { background: var(--success); color: white; }
    .hidden { display: none; }
    audio { width: 100%; margin-top: 10px; }
    #history { margin-top: 15px; }
    .history-item {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>ë§ì”€ ì•”ì†¡ ì œì¶œ</h1>
  <div class="card">
    <label>ì£¼ì°¨ ì„ íƒ</label>
    <select id="weekSelect"></select>

    <label>ì´ë¦„</label>
    <input id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" />

    <label>ì–¸ì–´ ì„ íƒ</label>
    <select id="lang">
      <option value="kr">í•œêµ­ì–´</option>
      <option value="en">English (ESV)</option>
    </select>

    <label>êµ¬ì ˆ ì„ íƒ</label>
    <div id="verseList"></div>
  </div>
  <div class="card">
    <button id="recordBtn" class="record-btn">ğŸ™ ë…¹ìŒ ì‹œì‘</button>
    <button id="stopBtn" class="stop-btn hidden">â¹ ë…¹ìŒ ì¢…ë£Œ</button>
    <audio id="audioPlayer" class="hidden" controls></audio>
    <button id="submitBtn" class="submit-btn hidden">âœ… ì œì¶œí•˜ê¸°</button>
    <p id="status" style="margin-top: 8px; font-size: 14px; color: var(--muted);"></p>
  </div>

  <div class="card">
    <h3>ğŸ“œ ì œì¶œ ê¸°ë¡</h3>
    <div id="history"></div>
  </div>

<script>
let verses = [];
let selectedVerse = 0;
let mediaRecorder;
let audioChunks = [];
let audioBlob = null;
let mimeType = "";
let nowWeekId = "";
let recorderActive = false;

// ====== êµ¬ì ˆ ë¶ˆëŸ¬ì˜¤ê¸° ======
async function loadVerses(weekId = null) {
  const res = await fetch("/verses");
  const data = await res.json();
  nowWeekId = data.week_id;
  verses = data.verses;

  document.getElementById("weekSelect").innerHTML = `
    <option value="${nowWeekId}">${data.title} (ì´ë²ˆ ì£¼)</option>
    <option value="2025-01-01">ì§€ë‚œ ì£¼ ì˜ˆì‹œ</option>
  `;

  renderVerses();
}

function renderVerses() {
  const container = document.getElementById("verseList");
  container.innerHTML = "";
  verses.forEach((v, i) => {
    const div = document.createElement("div");
    div.className = "verse-item" + (i === 0 ? " active" : "");
    div.innerText = v.verse_id;
    div.onclick = () => {
      document.querySelectorAll(".verse-item").forEach(e => e.classList.remove("active"));
      div.classList.add("active");
      selectedVerse = i;
    };
    container.appendChild(div);
  });
}

// ====== ë…¹ìŒ ======
document.getElementById("recordBtn").onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mimeType = MediaRecorder.isTypeSupported("audio/webm") ? "audio/webm" : "audio/mp4";

    mediaRecorder = new MediaRecorder(stream, { mimeType });
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: mimeType });
      const audioUrl = URL.createObjectURL(audioBlob);
      const player = document.getElementById("audioPlayer");
      player.src = audioUrl;
      player.classList.remove("hidden");

      document.getElementById("submitBtn").classList.remove("hidden");
      document.getElementById("stopBtn").classList.add("hidden");
      document.getElementById("recordBtn").classList.remove("hidden");
      document.getElementById("status").innerText = "ë…¹ìŒ ì™„ë£Œ. ì œì¶œí•˜ì„¸ìš”.";
    };

    mediaRecorder.start();
    document.getElementById("recordBtn").classList.add("hidden");
    document.getElementById("stopBtn").classList.remove("hidden");
    document.getElementById("status").innerText = "ë…¹ìŒ ì¤‘...";
  } catch (err) {
    alert("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
  }
};

document.getElementById("stopBtn").onclick = () => {
  mediaRecorder.stop();
};
// ====== ì œì¶œ ======
document.getElementById("submitBtn").onclick = async () => {
  const name = document.getElementById("name").value.trim();
  const lang = document.getElementById("lang").value;
  const weekId = document.getElementById("weekSelect").value;

  if (!name) {
    alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  if (!audioBlob) {
    alert("ë…¹ìŒ í›„ ì œì¶œí•´ì£¼ì„¸ìš”.");
    return;
  }

  const formData = new FormData();
  formData.append("audio", audioBlob, "recording");
  formData.append("name", name);
  formData.append("lang", lang);
  formData.append("verse_idx", selectedVerse);
  formData.append("week_id", weekId);
  formData.append("mime", mimeType);

  document.getElementById("status").innerText = "ì œì¶œ ì¤‘...";

  try {
    const response = await fetch("/submit", {
      method: "POST",
      body: formData,
    });
    const result = await response.json();

    if (result.ok) {
      addHistory(result);
      document.getElementById("status").innerText = "ì œì¶œ ì™„ë£Œ âœ…";

      // ë‹¤ìŒ êµ¬ì ˆ ìë™ ì´ë™
      if (selectedVerse < verses.length - 1) {
        selectedVerse++;
        document.querySelectorAll(".verse-item").forEach((e, i) => {
          e.classList.toggle("active", i === selectedVerse);
        });
      }
    } else {
      document.getElementById("status").innerText = "ì œì¶œ ì‹¤íŒ¨ âŒ";
    }
  } catch (e) {
    document.getElementById("status").innerText = "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ â—";
  }
};

// ====== ì œì¶œ ê¸°ë¡ ì¶”ê°€ ======
function addHistory(result) {
  const div = document.createElement("div");
  div.className = "history-item";
  div.innerHTML = `
    <b>${result.week_id}</b> | ${verses[selectedVerse].verse_id}<br>
    âœ” ì ìˆ˜: ${result.score} / í†µê³¼: ${result.passed ? "âœ…" : "âŒ"}<br>
    ğŸ§ <a href="${result.file_url}" target="_blank">ë…¹ìŒíŒŒì¼ ë³´ê¸°</a><br>
    ğŸ—£ ${result.transcript}
  `;
  document.getElementById("history").prepend(div);
}

// ====== ì‹¤í–‰ ======
loadVerses();
</script>
</body>
</html>
