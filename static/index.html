<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì•”ì†¡ ìë™ í™•ì¸</title>
<style>
  :root{
    --bg:#ffffff; --fg:#222; --muted:#6b7280;
    --card:#f4f6f8; --border:#e5e7eb;
    --brand:#2563eb; --brand-weak:#dbeafe;
    --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0f14; --fg:#e5e7eb; --card:#0f1720; --border:#1f2937; --brand:#3b82f6; --brand-weak:#10213d; }
  }
  *{box-sizing:border-box}
  body{background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif; max-width:560px; margin:0 auto; padding:20px}
  h2{margin:0 0 8px; font-size:22px; text-align:center}
  .muted{color:var(--muted)}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin-top:12px}
  label{font-weight:600; display:block; margin:14px 0 6px}
  input[type=text]{width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:inherit}
  .seg{display:flex; gap:8px; flex-wrap:wrap}
  .chip{padding:8px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer}
  .chip.active{background:var(--brand); color:#fff; border-color:var(--brand)}
  .verse-list{display:grid; gap:8px; margin-top:6px}
  .verse-option{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff0; cursor:pointer; transition:all .15s}
  .verse-option .bullet{width:18px; height:18px; border-radius:50%; border:2px solid var(--muted); display:inline-flex; align-items:center; justify-content:center; font-size:12px; color:transparent}
  .verse-option.active{border-color:var(--brand); background:var(--brand-weak)}
  .verse-option.active .bullet{border-color:var(--brand); background:var(--brand); color:#fff; content:"âœ“"}
  .btn{width:100%; padding:14px; border:none; border-radius:12px; font-weight:700; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all .15s}
  .btn:disabled{cursor:not-allowed; opacity:.6}
  .btn-record{background:var(--brand); color:#fff}
  .btn-stop{background:var(--warn); color:#fff}
  .btn-submit{background:var(--ok); color:#fff}
  .row{display:flex; gap:10px}
  .row .btn{flex:1}
  .status{margin-top:10px; font-size:14px}
  .status.bad{color:var(--danger)} .status.ok{color:var(--ok)}
  audio{width:100%; margin-top:8px}
  .spinner{width:16px;height:16px;border-radius:50%; border:3px solid rgba(255,255,255,.35); border-top-color:#fff; animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .dot{width:10px; height:10px; border-radius:50%; background:#ef4444; position:relative}
  .dot::after{content:""; position:absolute; inset:-6px; border-radius:50%; border:2px solid #ef4444; opacity:.6; animation:pulse 1.2s infinite}
  @keyframes pulse{0%{transform:scale(0.8);opacity:.6}100%{transform:scale(1.6);opacity:0}}
  .history{margin-top:12px; display:grid; gap:8px}
  .entry{border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff0}
  .entry .title{font-weight:700}
</style>
</head>
<body>
  <h2>ğŸ“– ì œìë°˜ ì•”ì†¡ ìë™ í™•ì¸</h2>
  <p class="muted" id="weekMeta" style="text-align:center;margin-top:-6px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>

  <div class="card">
    <label>ì´ë¦„</label>
    <input id="name" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name" />

    <label>ì–¸ì–´ ì„ íƒ</label>
    <div class="seg" id="langSeg">
      <div class="chip active" data-lang="kr">í•œêµ­ì–´</div>
      <div class="chip" data-lang="en">English (ESV)</div>
    </div>

    <label>ì´ë²ˆ ì£¼ êµ¬ì ˆ ì„ íƒ</label>
    <div id="verses" class="verse-list"></div>
  </div>

  <div class="card">
    <div class="row">
      <button id="recordBtn" class="btn btn-record"><span id="recIcon">ğŸ™ï¸</span><span id="recText">ë…¹ìŒ ì‹œì‘</span></button>
      <button id="stopBtn" class="btn btn-stop" disabled>â¹ï¸ ë…¹ìŒ ì¢…ë£Œ</button>
    </div>
    <button id="submitBtn" class="btn btn-submit" style="margin-top:10px" disabled>âœ… ì œì¶œí•˜ê¸°</button>

    <div class="status" id="status"></div>
    <audio id="audioPlayer" controls hidden></audio>
  </div>

  <div class="card">
    <div class="history" id="history"></div>
  </div>

<script>
let mediaRecorder, audioChunks = [], verses = [], recMime = "", recording = false;
let currentLang = "kr", verseIdx = 0, weekId = "", weekTitle = "";

const weekMeta = document.getElementById("weekMeta");
const versesBox = document.getElementById("verses");
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const submitBtn = document.getElementById("submitBtn");
const statusEl = document.getElementById("status");
const audioPlayer = document.getElementById("audioPlayer");
const recIcon = document.getElementById("recIcon");
const recText = document.getElementById("recText");
const historyBox = document.getElementById("history");

// ì–¸ì–´ í† ê¸€
document.getElementById("langSeg").addEventListener("click",(e)=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  [...e.currentTarget.querySelectorAll(".chip")].forEach(x=>x.classList.remove("active"));
  chip.classList.add("active");
  currentLang = chip.dataset.lang || "kr";
});

// êµ¬ì ˆ/ì£¼ì°¨ ë¶ˆëŸ¬ì˜¤ê¸°
fetch("/verses").then(r=>r.json()).then(data=>{
  verses = data.verses || [];
  weekId = data.week_id || "";
  weekTitle = data.title || weekId;
  weekMeta.textContent = `ì£¼ì°¨: ${weekTitle}`;
  renderVerses();
});

function renderVerses(){
  versesBox.innerHTML = verses.map((v,i)=>`
    <div class="verse-option ${i===verseIdx?'active':''}" data-idx="${i}">
      <div class="bullet">âœ“</div>
      <div class="verse-id">${v.verse_id}</div>
    </div>
  `).join("");
}
versesBox.addEventListener("click",(e)=>{
  const opt = e.target.closest(".verse-option"); if(!opt) return;
  [...versesBox.querySelectorAll(".verse-option")].forEach(x=>x.classList.remove("active"));
  opt.classList.add("active");
  verseIdx = Number(opt.dataset.idx || 0);
});

function setStatus(msg, type){
  statusEl.textContent = msg || "";
  statusEl.className = "status" + (type ? " " + type : "");
}

recordBtn.onclick = async () => {
  try{
    audioChunks = [];
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    const cand = [
      "audio/webm;codecs=opus",
      "audio/ogg;codecs=opus",
      "audio/mp4",
      "audio/mpeg"
    ];
    recMime = cand.find(t => MediaRecorder.isTypeSupported(t)) || "";
    mediaRecorder = new MediaRecorder(stream, recMime ? { mimeType: recMime } : undefined);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: recMime || "audio/webm" });
      audioPlayer.src = URL.createObjectURL(blob);
      audioPlayer.hidden = false;
      submitBtn.disabled = false;
      setStatus("ë…¹ìŒ ì™„ë£Œ. ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "ok");
      recIcon.textContent = "ğŸ™ï¸"; recText.textContent = "ë…¹ìŒ ì‹œì‘";
      recording = false;
    };
    mediaRecorder.start();
    recording = true;
    recIcon.innerHTML = '<span class="dot"></span>'; recText.textContent = "ë…¹ìŒ ì¤‘â€¦";
    setStatus("ë§ˆì´í¬ ì‚¬ìš© ì¤‘â€¦ ë§ì”€ì´ ëë‚˜ë©´ â€˜ë…¹ìŒ ì¢…ë£Œâ€™ë¥¼ ëˆ„ë¥´ì„¸ìš”.", "");
    recordBtn.disabled = true; stopBtn.disabled = false;
  }catch(e){
    setStatus("ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "bad");
  }
};

stopBtn.onclick = () => {
  try{
    if(mediaRecorder && recording){
      mediaRecorder.stop();
      stopBtn.disabled = true; recordBtn.disabled = false;
    }
  }catch(e){
    setStatus("ë…¹ìŒ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "bad");
  }
};

submitBtn.onclick = async () => {
  try{
    const name = document.getElementById("name").value.trim();
    if(!name){ setStatus("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", "bad"); return; }
    if(audioChunks.length === 0){ setStatus("ë¨¼ì € ë…¹ìŒí•˜ì„¸ìš”.", "bad"); return; }

    const blob = new Blob(audioChunks, { type: recMime || "audio/webm" });
    const form = new FormData();
    form.append("audio", blob, "rec");
    form.append("mime", recMime);
    form.append("name", name);
    form.append("lang", currentLang);
    form.append("verse_idx", String(verseIdx));
    form.append("week_id", weekId);

    // ë²„íŠ¼ ë¡œë”©
    submitBtn.disabled = true;
    const oldHtml = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner"></span> ì œì¶œ ì¤‘â€¦';
    setStatus("ì œì¶œ ì¤‘â€¦ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.", "");

    const res = await fetch("/submit", { method:"POST", body: form });
    const data = await res.json().catch(()=>({ok:false,error:"ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨"}));

    submitBtn.disabled = false;
    submitBtn.innerHTML = oldHtml;

    if(!res.ok || !data.ok){
      const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
      setStatus(`ì œì¶œ ì‹¤íŒ¨: ${msg}`, "bad");
      return;
    }

    // ëˆ„ì  ê¸°ë¡ì— ì¶”ê°€
    addHistoryEntry({
      idx: verseIdx,
      verse_id: (verses[verseIdx] || {}).verse_id || `#${verseIdx+1}`,
      passed: !!data.passed,
      scores: data.scores || [],
      transcript: data.transcript || "",
      link: data.file || "",
    });

    setStatus("ì œì¶œ ì™„ë£Œ!", "ok");

    // ë‹¤ìŒ êµ¬ì ˆë¡œ ìë™ ì§„í–‰
    if (verses.length > 0){
      verseIdx = (verseIdx + 1) % verses.length;
      renderVerses();
      // ë‹¤ìŒ êµ¬ì ˆì„ ë°”ë¡œ ë…¹ìŒí•  ìˆ˜ ìˆê²Œ ìƒíƒœ ì´ˆê¸°í™”
      audioChunks = [];
      audioPlayer.hidden = true;
      submitBtn.disabled = true;
      recordBtn.disabled = false; stopBtn.disabled = true;
      recIcon.textContent = "ğŸ™ï¸"; recText.textContent = "ë…¹ìŒ ì‹œì‘";
      if (verseIdx === 0) {
        setStatus("ì´ë²ˆ ì£¼ ë‘ êµ¬ì ˆ ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "ok");
      } else {
        setStatus("ë‹¤ìŒ êµ¬ì ˆì„ ë…¹ìŒí•´ ì£¼ì„¸ìš”.", "");
      }
    }
  }catch(e){
    submitBtn.disabled = false;
    setStatus("ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.", "bad");
  }
};

function addHistoryEntry({idx, verse_id, passed, scores, transcript, link}){
  const div = document.createElement("div");
  div.className = "entry";
  div.innerHTML = `
    <div class="title">#${idx+1} ${verse_id} â€” ${passed ? "âœ… í•©ê²©" : "âŒ ì¬ë„ì „"}</div>
    <div style="margin-top:6px">
      <div><b>ì ìˆ˜</b></div>
      <div>${(scores||[]).map(s => `${s.verse}: ${s.score}`).join("<br>")}</div>
    </div>
    <div style="margin-top:6px">
      <div><b>ì¸ì‹ ë¬¸ì¥</b></div>
      <div style="white-space:pre-wrap">${transcript || "-"}</div>
    </div>
    <div style="margin-top:6px">
      <b>ë§í¬</b>: ${link ? `<a href="${link}" target="_blank" rel="noopener">${link}</a>` : "ì—†ìŒ"}
    </div>
  `;
  historyBox.prepend(div); // ìµœì‹  ì œì¶œì´ ìœ„ë¡œ ì˜¤ë„ë¡
}
</script>
</body>
</html>
