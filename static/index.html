<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>말씀 암송 제출</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1e293b;
      --muted: #64748b;
      --card: #f8fafc;
      --border: #e2e8f0;
      --brand: #2563eb;
      --brand-light: #dbeafe;
      --success: #16a34a;
      --warn: #eab308;
      --danger: #dc2626;
    }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      line-height: 1.5;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 22px;
    }
    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 15px;
    }
    label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
      font-size: 15px;
    }
    .verse-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
    }
    .verse-item.active {
      background: var(--brand-light);
      border-color: var(--brand);
    }
    button {
      width: 100%;
      padding: 12px;
      border: none;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 600;
    }
    .record-btn { background: var(--brand); color: white; }
    .stop-btn { background: var(--warn); color: black; }
    .submit-btn { background: var(--success); color: white; }
    .hidden { display: none; }
    audio { width: 100%; margin-top: 10px; }
    #history { margin-top: 15px; }
    .history-item {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>말씀 암송 제출</h1>
  <div class="card">
    <label>주차 선택</label>
    <select id="weekSelect"></select>

    <label>이름</label>
    <input id="name" placeholder="이름을 입력하세요" autocomplete="off" />

    <label>언어 선택</label>
    <select id="lang">
      <option value="kr">한국어</option>
      <option value="en">English (ESV)</option>
    </select>

    <label>구절 선택</label>
    <div id="verseList"></div>
  </div>
  <div class="card">
    <button id="recordBtn" class="record-btn">🎙 녹음 시작</button>
    <button id="stopBtn" class="stop-btn hidden">⏹ 녹음 종료</button>
    <audio id="audioPlayer" class="hidden" controls></audio>
    <button id="submitBtn" class="submit-btn hidden">✅ 제출하기</button>
    <p id="status" style="margin-top: 8px; font-size: 14px; color: var(--muted);"></p>
  </div>

  <div class="card">
    <h3>📜 제출 기록</h3>
    <div id="history"></div>
  </div>

<script>
let verses = [];
let selectedVerse = 0;
let mediaRecorder;
let audioChunks = [];
let audioBlob = null;
let mimeType = "";
let nowWeekId = "";
let recorderActive = false;

// ====== 구절 불러오기 ======
async function loadVerses(weekId = null) {
  const res = await fetch("/verses");
  const data = await res.json();
  nowWeekId = data.week_id;
  verses = data.verses;

  document.getElementById("weekSelect").innerHTML = `
    <option value="${nowWeekId}">${data.title} (이번 주)</option>
    <option value="2025-01-01">지난 주 예시</option>
  `;

  renderVerses();
}

function renderVerses() {
  const container = document.getElementById("verseList");
  container.innerHTML = "";
  verses.forEach((v, i) => {
    const div = document.createElement("div");
    div.className = "verse-item" + (i === 0 ? " active" : "");
    div.innerText = v.verse_id;
    div.onclick = () => {
      document.querySelectorAll(".verse-item").forEach(e => e.classList.remove("active"));
      div.classList.add("active");
      selectedVerse = i;
    };
    container.appendChild(div);
  });
}

// ====== 녹음 ======
document.getElementById("recordBtn").onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mimeType = MediaRecorder.isTypeSupported("audio/webm") ? "audio/webm" : "audio/mp4";

    mediaRecorder = new MediaRecorder(stream, { mimeType });
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: mimeType });
      const audioUrl = URL.createObjectURL(audioBlob);
      const player = document.getElementById("audioPlayer");
      player.src = audioUrl;
      player.classList.remove("hidden");

      document.getElementById("submitBtn").classList.remove("hidden");
      document.getElementById("stopBtn").classList.add("hidden");
      document.getElementById("recordBtn").classList.remove("hidden");
      document.getElementById("status").innerText = "녹음 완료. 제출하세요.";
    };

    mediaRecorder.start();
    document.getElementById("recordBtn").classList.add("hidden");
    document.getElementById("stopBtn").classList.remove("hidden");
    document.getElementById("status").innerText = "녹음 중...";
  } catch (err) {
    alert("마이크 권한을 허용해주세요.");
  }
};

document.getElementById("stopBtn").onclick = () => {
  mediaRecorder.stop();
};
// ====== 제출 ======
document.getElementById("submitBtn").onclick = async () => {
  const name = document.getElementById("name").value.trim();
  const lang = document.getElementById("lang").value;
  const weekId = document.getElementById("weekSelect").value;

  if (!name) {
    alert("이름을 입력해주세요.");
    return;
  }
  if (!audioBlob) {
    alert("녹음 후 제출해주세요.");
    return;
  }

  const formData = new FormData();
  formData.append("audio", audioBlob, "recording");
  formData.append("name", name);
  formData.append("lang", lang);
  formData.append("verse_idx", selectedVerse);
  formData.append("week_id", weekId);
  formData.append("mime", mimeType);

  document.getElementById("status").innerText = "제출 중...";

  try {
    const response = await fetch("/submit", {
      method: "POST",
      body: formData,
    });
    const result = await response.json();

    if (result.ok) {
      addHistory(result);
      document.getElementById("status").innerText = "제출 완료 ✅";

      // 다음 구절 자동 이동
      if (selectedVerse < verses.length - 1) {
        selectedVerse++;
        document.querySelectorAll(".verse-item").forEach((e, i) => {
          e.classList.toggle("active", i === selectedVerse);
        });
      }
    } else {
      document.getElementById("status").innerText = "제출 실패 ❌";
    }
  } catch (e) {
    document.getElementById("status").innerText = "서버 오류 발생 ❗";
  }
};

// ====== 제출 기록 추가 ======
function addHistory(result) {
  const div = document.createElement("div");
  div.className = "history-item";
  div.innerHTML = `
    <b>${result.week_id}</b> | ${verses[selectedVerse].verse_id}<br>
    ✔ 점수: ${result.score} / 통과: ${result.passed ? "✅" : "❌"}<br>
    🎧 <a href="${result.file_url}" target="_blank">녹음파일 보기</a><br>
    🗣 ${result.transcript}
  `;
  document.getElementById("history").prepend(div);
}

// ====== 실행 ======
loadVerses();
</script>
</body>
</html>
